<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>G√¶st Val√®ncia - Sandra IA 7.0 (Pack √önico)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      background: #f3f4f6;
      min-height: 100vh;
      margin: 0;
      font-family: system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #main {
      background: #fff;
      max-width: 440px;
      margin: 2.5rem auto 2rem auto;
      border-radius: 12px;
      box-shadow: 0 2px 24px rgba(0,0,0,0.10);
      padding: 2rem 1.5rem 1.5rem 1.5rem;
      text-align: center;
    }
    h1, h2 {
      color: #2563eb;
      font-weight: 700;
      margin: 0.3rem 0 0.4rem 0;
    }
    .messages {
      height: 310px;
      overflow-y: auto;
      border-radius: 8px;
      background: #eef2ff;
      border: 1px solid #c7d2fe;
      margin: 0.7rem 0 0.1rem 0;
      padding: 0.7rem 0.7rem 0.2rem 0.7rem;
      text-align: left;
    }
    .chat-msg {
      max-width: 84%;
      margin-bottom: 0.32rem;
      padding: 0.45rem 0.8rem;
      border-radius: 20px;
      font-size: 1rem;
      word-break: break-word;
      box-shadow: 0 1px 3px rgb(80 112 221 / 9%);
    }
    .chat-user {
      background: #2563eb;
      color: #fff;
      margin-left: 16%;
      border-bottom-right-radius: 3px;
      text-align: right;
    }
    .chat-sandra {
      background: #f1f5f9;
      color: #0f172a;
      margin-right: 16%;
      border-bottom-left-radius: 3px;
    }
    .controls-row {
      display: flex;
      gap: 0.4rem;
      margin: 0.4rem 0;
    }
    input[type="text"] {
      flex: 1;
      padding: 0.55rem 0.7rem;
      border-radius: 7px;
      border: 1.3px solid #cfd6ee;
      font-size: 1rem;
    }
    input[type="text"]:focus {
      outline: 2px solid #3b82f6;
      border-color: #2563eb;
    }
    button {
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 7px;
      font-weight: 600;
      padding: 0.7rem 1.1rem;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:disabled {
      background: #b4bdfc;
      cursor: not-allowed;
    }
    button#speakBtn {
      background: #059669;
    }
    button#payBtn {
      background: #d97706;
      font-size: 1.02em;
    }
    .status {
      min-height: 1em;
      color: #2563eb;
      font-weight: 600;
      font-size: 0.97em;
      margin: 0.17rem 0 0.58rem 0;
    }
    #payFlow {
      background: #f0fdf4;
      color: #166534;
      border: 1px solid #a7f3d0;
      border-radius: 8px;
      margin-top: 1.1rem;
      padding: 1.38rem 1rem;
      display: none;
      font-size: 1.07em;
      position: relative;
      text-align: left;
    }
    #closePay {
      background: #ecfdf5;
      color: #166534;
      border: none;
      border-radius: 6px;
      font-size: 0.96em;
      position: absolute;
      top: 9px;
      right: 9px;
      padding: 0.3em 0.7em;
      cursor: pointer;
    }
    footer {
      margin-top: 2rem;
      color: #64748b;
      font-size: 0.93em;
      text-align: center;
      max-width: 440px;
    }
  </style>
</head>
<body>
  <div id="main">
    <h1>Sandra IA 7.0</h1>
    <h2>G√¶st Val√®ncia - Sistema √önico</h2>
    <div class="messages" id="msgLog" aria-label="Conversaci√≥n" aria-live="polite"></div>
    <div class="status" id="statusLine">&nbsp;</div>
    <form onsubmit="return false;" class="controls-row">
      <button id="speakBtn" title="Habla con Sandra IA" type="button" aria-pressed="false">üéôÔ∏è</button>
      <input id="msgInput" type="text" placeholder="Escribe o habla aqu√≠..." aria-label="Mensaje a Sandra IA" autocomplete="off" />
      <button id="sendBtn" type="button" title="Enviar mensaje a Sandra">Enviar</button>
    </form>
    <button id="payBtn" title="Iniciar Pago F√°cil Sandra">üí≥ Pago F√°cil</button>
    <div id="payFlow">
      <button id="closePay">Salir</button>
      <strong>Pago F√°cil est√° activo.</strong>
      <br>Por favor sigue las instrucciones de Sandra IA para completar tu reserva y pago de forma guiada y segura.<br><br>
      <span id="payStep"></span>
    </div>
  </div>
  <footer>
    Versi√≥n compacta autocontenida: Sandra IA con Barge-In, chat, voz, demo Pago F√°cil y l√≥gica integrada para desarrollo PRO.<br>
    Listo para pruebas, extensible a integraci√≥n backend profesional o cloud real.<br><br>
    <span style="font-size:0.9em;color:#334155;">
      G√¶st Val√®ncia &copy; 2025 Proyecto IA Multimodal.
    </span>
  </footer>
<script>
(function() {
  // --- ELEMENTOS Y ESTADO ---
  const msgLog = document.getElementById('msgLog');
  const statusLine = document.getElementById('statusLine');
  const speakBtn = document.getElementById('speakBtn');
  const sendBtn = document.getElementById('sendBtn');
  const msgInput = document.getElementById('msgInput');
  const payBtn = document.getElementById('payBtn');
  const payFlow = document.getElementById('payFlow');
  const closePay = document.getElementById('closePay');
  const payStep = document.getElementById('payStep');

  let isListening = false;
  let isSpeaking = false;
  let bargeInActive = false;
  let recognition = null;
  let synth = window.speechSynthesis;
  let utterance = null;
  let pagoFacil = false;
  let conversation = [];

  // --- UI/UX ---
  function printMsg(text, who = 'sandra') {
    const div = document.createElement('div');
    div.className = 'chat-msg ' + (who === 'user' ? 'chat-user' : 'chat-sandra');
    div.textContent = text;
    msgLog.appendChild(div);
    msgLog.scrollTop = msgLog.scrollHeight + 80;
    conversation.push({ sender: who, text });
  }

  function setStatus(txt = '') {
    statusLine.textContent = txt;
  }

  // --- IA simulada / LOGICA SANDRA ---
  async function handleSandra(message) {
    // IA local patr√≥n, aqu√≠ se conecta API real si quisieras escalar.
    let response = "No he entendido eso. ¬øPuedes reformularlo?";
    const lmsg = message.toLowerCase();

    if (lmsg.match(/hola|buenas|buenos/))      response = "¬°Hola! ¬øEn qu√© puedo ayudarte con tu alojamiento en Val√®ncia?";
    else if (lmsg.match(/reserva/))            response = "¬øSobre qu√© alojamiento y fechas necesitas reservar?";
    else if (lmsg.match(/pago f√°cil|easy pay|pagar|pago/)) activatePagoFacil();
    else if (lmsg.match(/precio|coste/))       response = "El coste depende de las fechas y alojamiento. ¬øQu√© prefieres consultar?";
    else if (lmsg.match(/gracias|gr√°cias/))    response = "De nada, ¬°siempre a tu disposici√≥n!";
    else if (lmsg.match(/adi√≥s|chau|ciao/))    response = "¬°Hasta pronto!";

    if (pagoFacil && (!lmsg.match(/pago f√°cil|easy pay/))) {
      // Flujo guiado sencillo demo de pago f√°cil
      if(lmsg.match(/confirmar|acepto|pagar/)) {
        response = "Reserva confirmada y pagada. En minutos tendr√°s email con tu comprobante.";
        deactivatePagoFacil(true);
      } else {
        response = "Confirma con 'acepto' y proceder√© a gestionar tu pago y reserva.";
      }
    }

    // Evita respuesta doble al activar Pago F√°cil
    if (response) {
      printMsg(response, 'sandra');
      await speak(response);
    }
  }

  // --- VOZ ---
  function speak(text) {
    return new Promise(resolve => {
      if (synth.speaking) synth.cancel();
      isSpeaking = true; setStatus('Sandra hablando...');
      utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "es-ES";
      utterance.onend = () => { isSpeaking = false; setStatus(''); resolve(); };
      utterance.onerror = () => { isSpeaking = false; setStatus('Error de s√≠ntesis'); resolve(); };
      synth.speak(utterance);
    });
  }

  // --- RECONOCIMIENTO DE VOZ BARGE-IN ---
  function startListening() {
    if (!('webkitSpeechRecognition' in window)) {
      alert("Reconocimiento de voz no soportado");
      return;
    }
    recognition = new window.webkitSpeechRecognition();
    recognition.lang = "es-ES";
    recognition.interimResults = false;
    recognition.continuous = false;
    recognition.onstart = function() {
      isListening = true;
      bargeInActive = true;
      speakBtn.setAttribute('aria-pressed', 'true');
      setStatus("Escuchando... (Barge-In activo)");
      if(isSpeaking) synth.cancel();
      isSpeaking = false;
    };
    recognition.onresult = async function(event) {
      const recognText = event.results[0][0].transcript;
      isListening = false; bargeInActive = false;
      speakBtn.setAttribute('aria-pressed', 'false');
      setStatus('');
      printMsg(recognText, 'user');
      await handleSandra(recognText.trim());
    };
    recognition.onerror = function(e) {
      isListening = false;
      bargeInActive = false;
      speakBtn.setAttribute('aria-pressed', 'false');
      setStatus("Error de voz: "+e.error);
    };
    recognition.onend = function() {
      isListening = false;
      bargeInActive = false;
      speakBtn.setAttribute('aria-pressed', 'false');
      setStatus('');
    };
    recognition.start();
  }

  // --- FLUJO UI Y HANDLERS ---
  function activatePagoFacil() {
    if (!pagoFacil) {
      pagoFacil = true;
      payFlow.style.display = 'block';
      payStep.textContent = "¬øConfirmas que deseas proceder con el pago de tu reserva?";
      printMsg("Iniciando el Pago F√°cil. Lee atentamente y confirma cuando est√©s listo.", 'sandra');
      speak("Iniciando el Pago F√°cil. Lee atentamente y confirma cuando est√©s listo.");
    }
  }
  function deactivatePagoFacil(confirm) {
    pagoFacil = false; payFlow.style.display = 'none';
    if(confirm){
      printMsg("Pago y reserva completados ‚úîÔ∏è. ¬øNecesitas algo m√°s?", 'sandra');
      speak("Pago y reserva completados. ¬øDeseas ayuda con algo m√°s?");
    }
  }

  // --- EVENTOS ---
  speakBtn.onclick = () => {
    if(isListening && recognition) recognition.stop();
    else startListening();
  };
  sendBtn.onclick = async () => {
    const text = msgInput.value.trim();
    if(!text) return;
    printMsg(text, 'user');
    msgInput.value = '';
    await handleSandra(text);
  };
  msgInput.onkeydown = e => { if(e.key === 'Enter'){ sendBtn.click();}};
  payBtn.onclick = () => { activatePagoFacil(); };
  closePay.onclick = () => { deactivatePagoFacil(false); };

  // --- BOOT ---
  printMsg("¬°Hola! Soy Sandra, IA pro con voz y Pago F√°cil. Preg√∫ntame cualquier cosa o haz tu reserva.", 'sandra');
})();
</script>
</body>
</html>
