<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClayTomSystems - Centro de Comando Empresarial con Sandra GPT-5</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #020617;
            min-height: 100vh;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        #scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* HUD Centro de Comando */
        .hud {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(2, 6, 23, 0.8);
            padding: 20px 24px;
            border-radius: 16px;
            border: 1px solid #0ea5e9;
            backdrop-filter: blur(10px);
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(14, 165, 233, 0.2);
        }
        
        .hud strong {
            font-size: 18px;
            color: #0ea5e9;
            display: block;
            margin-bottom: 15px;
        }
        
        .hud .subtitle {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 20px;
        }
        
        .btn {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: #ffffff;
            border: none;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            margin: 4px 8px 4px 0;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }
        
        .btn:hover {
            background: linear-gradient(135deg, #0284c7, #0369a1);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(14, 165, 233, 0.4);
        }
        
        #status {
            display: inline-block;
            margin-left: 12px;
            padding: 6px 12px;
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        
        /* M√©tricas en Tiempo Real */
        .metrics {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(2, 6, 23, 0.8);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            backdrop-filter: blur(10px);
            z-index: 1000;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 13px;
        }
        
        .metric-value {
            color: #ef4444;
            font-weight: 600;
        }
        
        /* Informaci√≥n Corporativa */
        .company-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(2, 6, 23, 0.8);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(14, 165, 233, 0.3);
            backdrop-filter: blur(10px);
            max-width: 300px;
            z-index: 1000;
        }
        
        .company-info h3 {
            margin: 0 0 10px 0;
            color: #0ea5e9;
            font-size: 16px;
        }
        
        .company-info p {
            margin: 5px 0;
            font-size: 13px;
            opacity: 0.8;
        }
        
        @media (max-width: 768px) {
            .hud {
                top: 10px;
                left: 10px;
                right: 10px;
                padding: 15px;
            }
            
            .btn {
                padding: 10px 12px;
                margin: 3px 5px 3px 0;
                font-size: 12px;
            }
            
            .company-info, .metrics {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="scene"></div>
    
    <!-- HUD Centro de Comando -->
    <div class="hud">
        <strong>ClayTomSystems ‚Äî Centro de Comando Empresarial</strong>
        <div class="subtitle">Gesti√≥n de Infraestructura Molecular</div>
        
        <div>
            <button class="btn" onclick="sendCommand('system.activate', {agents: 50})">üöÄ Activar 50 Agentes</button>
            <button class="btn" onclick="sendCommand('system.scale', {nodes: 100})">‚ö° Escalar 100 Nodos</button>
            <button class="btn" onclick="sendCommand('ai.train', {models: 25})">üß† Entrenar 25 Modelos</button>
        </div>
        
        <div style="margin-top: 12px;">
            <button class="btn" onclick="sendCommand('deploy.production', {services: 'all'})">üåê Desplegar Producci√≥n</button>
            <button class="btn" onclick="sendCommand('security.scan', {depth: 'full'})">üõ°Ô∏è Escaneo Seguridad</button>
            <button class="btn" onclick="sendCommand('optimize.performance', {target: 'global'})">‚öôÔ∏è Optimizar</button>
        </div>
        
        <span id="status">LISTO</span>
    </div>
    
    <!-- M√©tricas en Tiempo Real -->
    <div class="metrics">
        <h4 style="margin: 0 0 12px 0; color: #ef4444; font-size: 14px;">‚ö° M√©tricas en Vivo</h4>
        <div class="metric">
            <span>Agentes Activos:</span>
            <span class="metric-value" id="agents">1,247</span>
        </div>
        <div class="metric">
            <span>Poder de Procesamiento:</span>
            <span class="metric-value" id="power">89.4%</span>
        </div>
        <div class="metric">
            <span>Carga de Red:</span>
            <span class="metric-value" id="network">67.2%</span>
        </div>
        <div class="metric">
            <span>Estado de Seguridad:</span>
            <span class="metric-value" id="security">PROTEGIDO</span>
        </div>
    </div>
    
    <!-- Informaci√≥n Corporativa -->
    <div class="company-info">
        <h3>üè¢ ClayTomSystems Corp</h3>
        <p><strong>CEO:</strong> Clay Thomas</p>
        <p><strong>Enfoque:</strong> Infraestructura IA y Automatizaci√≥n</p>
        <p><strong>Servicios:</strong> Soluciones IA Empresariales</p>
        <p><strong>Email:</strong> info@claytomsystems.com</p>
        <p style="margin-top: 15px; font-size: 11px; opacity: 0.6;">
            Dise√±o molecular por GPT-5 ‚ö°
        </p>
    </div>

    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script>
        // Molecular 3D Scene Setup
        const container = document.getElementById('scene');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x020617, 1);
        container.appendChild(renderer.domElement);

        // Create multiple particle systems for molecular effect
        const particleSystems = [];
        
        // Create smooth round points system - BLUE ONLY
        const createSmoothPointSystem = (count, color, size, speed) => {
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(count * 3);
            
            // Generate smooth distribution
            for (let i = 0; i < count; i++) {
                const index = i * 3;
                
                // Simple spherical distribution
                const radius = Math.random() * 200 + 50;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                
                positions[index] = radius * Math.sin(phi) * Math.cos(theta);
                positions[index + 1] = radius * Math.sin(phi) * Math.sin(theta);
                positions[index + 2] = radius * Math.cos(phi);
            }
            
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            // Create perfectly round texture
            const canvas = document.createElement('canvas');
            canvas.width = 32;
            canvas.height = 32;
            const context = canvas.getContext('2d');
            
            // Perfect circle with soft edges
            const gradient = context.createRadialGradient(16, 16, 0, 16, 16, 16);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
            gradient.addColorStop(0.7, 'rgba(255, 255, 255, 0.5)');
            gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
            
            context.fillStyle = gradient;
            context.beginPath();
            context.arc(16, 16, 16, 0, Math.PI * 2);
            context.fill();
            
            const texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;
            
            const material = new THREE.PointsMaterial({
                color: color,
                size: size,
                map: texture,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending,
                sizeAttenuation: true
            });
            
            const points = new THREE.Points(geometry, material);
            points.userData = { speed: speed };
            return points;
        };

        // Create smooth blue points system - ULTRA SLOW AND SMOOTH
        particleSystems.push(createSmoothPointSystem(2000, 0x0ea5e9, 1.5, 0.0002)); // Main blue layer - MUCH SLOWER
        particleSystems.push(createSmoothPointSystem(1000, 0x0284c7, 2, 0.0001)); // Darker blue layer - ULTRA SLOW
        particleSystems.push(createSmoothPointSystem(500, 0x0369a1, 1, 0.0003)); // Deep blue layer - SLOWER

        particleSystems.forEach(system => scene.add(system));

        camera.position.z = 220;

        // Enhanced animation loop with smooth circular motion
        function animate() {
            requestAnimationFrame(animate);
            
            particleSystems.forEach((system, index) => {
                // ULTRA SLOW smooth rotation - MUCH MORE GENTLE
                system.rotation.y += system.userData.speed;
                system.rotation.x += system.userData.speed * 0.3;
                
                // ULTRA gentle opacity pulsing - SUPER SLOW
                const time = Date.now() * 0.0003; // Much slower time multiplier
                system.material.opacity = 0.75 + Math.sin(time + index) * 0.05; // Smaller variation
            });
            
            renderer.render(scene, camera);
        }
        animate();

        // Command system with enhanced feedback
        async function sendCommand(type, payload) {
            const status = document.getElementById('status');
            status.textContent = 'PROCESANDO...';
            status.style.background = 'rgba(239, 68, 68, 0.2)';
            status.style.color = '#ef4444';
            
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 800));
                
                status.textContent = '√âXITO';
                status.style.background = 'rgba(34, 197, 94, 0.2)';
                status.style.color = '#22c55e';
                
                console.log(`Command executed: ${type}`, payload);
                
                // Update metrics
                updateMetrics();
                
                // Reset status after delay
                setTimeout(() => {
                    status.textContent = 'LISTO';
                }, 2000);
                
            } catch (error) {
                status.textContent = 'ERROR';
                status.style.background = 'rgba(239, 68, 68, 0.3)';
                status.style.color = '#ef4444';
                console.error('Command failed:', error);
            }
        }

        // Real-time metrics simulation
        function updateMetrics() {
            document.getElementById('agents').textContent = Math.floor(Math.random() * 500 + 1000).toLocaleString();
            document.getElementById('power').textContent = (Math.random() * 20 + 75).toFixed(1) + '%';
            document.getElementById('network').textContent = (Math.random() * 30 + 50).toFixed(1) + '%';
            
            const securityStates = ['PROTEGIDO', 'ESCANEANDO', 'OPTIMIZADO'];
            document.getElementById('security').textContent = securityStates[Math.floor(Math.random() * securityStates.length)];
        }

        // Update metrics every 5 seconds
        setInterval(updateMetrics, 5000);

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Initialize metrics
        updateMetrics();
    </script>

    <!-- Sandra Widget Script -->
    <script>
        /**
         * üöÄ SANDRA IA 7.0 - Widget Conversacional Completo
         */

        (function() {
            'use strict';
            
            // Prevenir m√∫ltiples instancias
            if (window.sandraWidgetLoaded) return;
            window.sandraWidgetLoaded = true;
            
            console.log('üöÄ Iniciando Sandra Widget Conversacional Completo');
            
            // Variables globales
            let isOpen = false;
            let isRecording = false;
            let mediaRecorder = null;
            let audioChunks = [];
            let silenceTimer = null;
            let audioContext = null;
            let analyser = null;
            let isListening = false;
            
            // Crear el widget
            function createWidget() {
                const widgetHTML = `
                    <div id="sandra-widget" style="position: fixed; bottom: 20px; right: 20px; z-index: 99999; font-family: Arial, sans-serif;">
                        <!-- Bot√≥n flotante -->
                        <button id="sandra-btn" style="
                            width: 70px; height: 70px; 
                            background: linear-gradient(45deg, #3b82f6, #10b981); 
                            border: none; border-radius: 50%; 
                            box-shadow: 0 4px 20px rgba(0,0,0,0.3); 
                            cursor: pointer; font-size: 28px; color: white;
                            transition: transform 0.2s ease;
                        ">üé§</button>
                        
                        <!-- Panel conversacional -->
                        <div id="sandra-panel" style="
                            position: absolute; bottom: 80px; right: 0; 
                            width: 300px; height: 400px;
                            background: white; border-radius: 15px; 
                            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
                            display: none; overflow: hidden;
                        ">
                            <!-- Header -->
                            <div style="background: linear-gradient(45deg, #3b82f6, #10b981); color: white; padding: 15px; text-align: center;">
                                <h3 style="margin: 0; font-size: 16px;">üöÄ Sandra IA 7.0</h3>
                                <p style="margin: 5px 0 0 0; font-size: 12px;" id="connection-status">Conectando...</p>
                            </div>
                            
                            <!-- Chat -->
                            <div id="chat-area" style="height: 250px; padding: 10px; overflow-y: auto; background: #f8f9fa;">
                            </div>
                            
                            <!-- Controls -->
                            <div style="padding: 15px; background: #f1f3f4; text-align: center;">
                                <button id="mic-btn" style="
                                    width: 50px; height: 50px; 
                                    background: #10b981; border: none; 
                                    border-radius: 50%; cursor: pointer; 
                                    font-size: 20px; color: white;
                                    margin-bottom: 5px;
                                " disabled>üé§</button>
                                <div style="font-size: 11px; color: #666;" id="mic-status">Preparando...</div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', widgetHTML);
                setupEvents();
                initMicrophone();
                testConnection();
            }
            
            function setupEvents() {
                const btn = document.getElementById('sandra-btn');
                const panel = document.getElementById('sandra-panel');
                const micBtn = document.getElementById('mic-btn');
                
                btn.addEventListener('click', () => {
                    isOpen = !isOpen;
                    panel.style.display = isOpen ? 'block' : 'none';
                    console.log('Panel toggled:', isOpen);
                });
                
                micBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    console.log('üñ±Ô∏è Click en micr√≥fono, modo continuo:', isListening);
                    
                    if (isListening) {
                        console.log('üõë Parando modo conversacional...');
                        stopContinuousListening();
                    } else {
                        console.log('üéß Iniciando modo conversacional continuo...');
                        startContinuousListening();
                    }
                });
                
                btn.addEventListener('mouseover', () => {
                    btn.style.transform = 'scale(1.1)';
                });
                
                btn.addEventListener('mouseout', () => {
                    btn.style.transform = 'scale(1)';
                });
            }
            
            async function initMicrophone() {
                try {
                    console.log('üé§ Inicializando micr√≥fono...');
                    
                    // Configuraci√≥n mejorada del micr√≥fono
                    const constraints = {
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            channelCount: 1,
                            sampleRate: 16000
                        }
                    };
                    
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    console.log('üì± Stream obtenido:', stream.getAudioTracks().length, 'pistas de audio');
                    
                    // Configurar MediaRecorder con opciones espec√≠ficas
                    const options = {
                        mimeType: 'audio/webm;codecs=opus',
                        audioBitsPerSecond: 16000
                    };
                    
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                        console.log('‚ö†Ô∏è webm no soportado, usando formato por defecto');
                        mediaRecorder = new MediaRecorder(stream);
                    } else {
                        mediaRecorder = new MediaRecorder(stream, options);
                    }
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                            console.log('üì¶ Chunk de audio:', event.data.size, 'bytes');
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        console.log('‚èπÔ∏è Grabaci√≥n terminada, procesando...');
                        processAudio();
                    };
                    
                    mediaRecorder.onerror = (event) => {
                        console.error('‚ùå Error en MediaRecorder:', event.error);
                        updateMicStatus('‚ùå Error grabaci√≥n');
                    };
                    
                    document.getElementById('mic-btn').disabled = false;
                    updateMicStatus('üé§ Listo');
                    console.log('‚úÖ Micr√≥fono configurado correctamente');
                    
                } catch (error) {
                    console.error('‚ùå Error micr√≥fono:', error);
                    updateMicStatus('‚ùå Sin mic');
                    addMessage('‚ùå No se pudo acceder al micr√≥fono. Verifica los permisos.', 'sandra');
                }
            }
            
            // Modo conversacional continuo
            async function startContinuousListening() {
                try {
                    console.log('üéß Iniciando modo conversacional continuo...');
                    isListening = true;
                    
                    // Configurar an√°lisis de audio para detectar voz/silencio
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });
                    
                    const source = audioContext.createMediaStreamSource(stream);
                    source.connect(analyser);
                    
                    analyser.fftSize = 256;
                    
                    // Configurar MediaRecorder
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    const micBtn = document.getElementById('mic-btn');
                    micBtn.style.background = '#ef4444';
                    micBtn.textContent = 'üî¥';
                    updateMicStatus('üéß Escuchando... (habla cuando quieras)');
                    
                    // Iniciar detecci√≥n continua
                    detectSpeechAndSilence();
                    
                } catch (error) {
                    console.error('‚ùå Error modo continuo:', error);
                    updateMicStatus('‚ùå Error');
                    isListening = false;
                }
            }
            
            function stopContinuousListening() {
                console.log('üõë Parando modo conversacional...');
                isListening = false;
                
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                    silenceTimer = null;
                }
                
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
                
                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }
                
                const micBtn = document.getElementById('mic-btn');
                micBtn.style.background = '#10b981';
                micBtn.textContent = 'üé§';
                updateMicStatus('üé§ Listo');
            }
            
            function detectSpeechAndSilence() {
                if (!isListening || !analyser) return;
                
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                analyser.getByteFrequencyData(dataArray);
                
                // Calcular volumen promedio
                let sum = 0;
                for (let i = 0; i < bufferLength; i++) {
                    sum += dataArray[i];
                }
                const average = sum / bufferLength;
                
                // Umbral de voz (ajustable)
                const speechThreshold = 30;
                
                if (average > speechThreshold) {
                    // HAY VOZ - iniciar/continuar grabaci√≥n
                    if (!isRecording) {
                        startRecording();
                    }
                    
                    // Cancelar timer de silencio
                    if (silenceTimer) {
                        clearTimeout(silenceTimer);
                        silenceTimer = null;
                    }
                    
                } else {
                    // SILENCIO - configurar timer para parar
                    if (isRecording && !silenceTimer) {
                        silenceTimer = setTimeout(() => {
                            console.log('ü§´ Silencio detectado, procesando...');
                            stopRecording();
                            silenceTimer = null;
                        }, 2000); // 2 segundos de silencio
                    }
                }
                
                // Continuar detectando
                if (isListening) {
                    setTimeout(() => detectSpeechAndSilence(), 100);
                }
            }
            
            function startRecording() {
                try {
                    console.log('üî¥ Iniciando grabaci√≥n...');
                    audioChunks = [];
                    
                    // Verificar que el MediaRecorder est√© listo
                    if (!mediaRecorder || mediaRecorder.state === 'recording') {
                        console.log('‚ö†Ô∏è MediaRecorder no listo o ya grabando');
                        return;
                    }
                    
                    mediaRecorder.start(1000); // Grabar en chunks de 1 segundo
                    isRecording = true;
                    
                    const micBtn = document.getElementById('mic-btn');
                    micBtn.style.background = '#ef4444';
                    micBtn.textContent = '‚èπÔ∏è';
                    updateMicStatus('üî¥ Grabando... (habla ahora)');
                    
                    console.log('‚úÖ Grabaci√≥n iniciada, estado:', mediaRecorder.state);
                    
                } catch (error) {
                    console.error('‚ùå Error iniciando grabaci√≥n:', error);
                    updateMicStatus('‚ùå Error grabaci√≥n');
                }
            }
            
            function stopRecording() {
                try {
                    console.log('‚èπÔ∏è Parando grabaci√≥n... Estado actual:', mediaRecorder?.state);
                    
                    // Forzar parada
                    isRecording = false;
                    
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                        console.log('‚úÖ MediaRecorder.stop() ejecutado');
                    } else {
                        console.log('‚ö†Ô∏è MediaRecorder no estaba grabando, estado:', mediaRecorder?.state);
                    }
                    
                    const micBtn = document.getElementById('mic-btn');
                    micBtn.style.background = '#10b981';
                    micBtn.textContent = 'üé§';
                    updateMicStatus('‚è≥ Procesando audio...');
                    
                    console.log('üìä Chunks capturados:', audioChunks.length);
                    
                    // Procesar inmediatamente si hay chunks
                    if (audioChunks.length > 0) {
                        console.log('‚úÖ Procesando audio inmediatamente');
                        setTimeout(() => processAudio(), 500);
                    } else {
                        // Forzar respuesta manual si no hay audio
                        console.log('‚ö†Ô∏è No hay chunks, procesando manual');
                        addMessage('Audio capturado, enviando a Sandra...', 'user');
                        setTimeout(() => processAudioManual(), 1000);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error parando grabaci√≥n:', error);
                    updateMicStatus('‚ùå Error');
                }
            }
            
            async function processAudio() {
                console.log('üéµ Procesando audio...');
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                
                try {
                    // Convertir audio a base64
                    const arrayBuffer = await audioBlob.arrayBuffer();
                    const base64Audio = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
                    
                    // Enviar al servidor Sandra IA 7.0
                    const response = await fetch('http://127.0.0.1:7100/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            audio: base64Audio,
                            format: 'webm',
                            timestamp: Date.now(),
                            userId: 'ceo'
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        
                        // Mostrar transcripci√≥n si existe
                        if (result.transcription) {
                            addMessage(result.transcription, 'user');
                        }
                        
                        // Mostrar respuesta de Sandra
                        if (result.reply || result.response) {
                            const reply = result.reply || result.response;
                            addMessage(reply, 'sandra');
                            
                            // Usar ElevenLabs TTS
                            speakWithElevenLabs(reply);
                        }
                        
                        updateMicStatus('‚úÖ Listo');
                        console.log('‚úÖ Respuesta de Sandra recibida');
                        
                    } else {
                        console.error('‚ùå Error del servidor:', response.status);
                        updateMicStatus('‚ùå Error');
                        
                        // Fallback a respuesta simulada
                        const fallbackResponse = "Hola, soy Sandra de ClayTomSystems. ¬øEn qu√© puedo ayudarte con nuestros servicios empresariales?";
                        addMessage(fallbackResponse, 'sandra');
                        speakWithElevenLabs(fallbackResponse);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error procesando:', error);
                    updateMicStatus('‚ùå Error');
                    
                    // Fallback a respuesta simulada
                    const fallbackResponse = "Soy Sandra, tu asistente de ClayTomSystems. ¬øC√≥mo puedo ayudarte hoy?";
                    addMessage(fallbackResponse, 'sandra');
                    speakWithElevenLabs(fallbackResponse);
                }
            }
            
            // Funci√≥n de respaldo para procesar manualmente
            async function processAudioManual() {
                console.log('üîß Procesamiento manual iniciado');
                
                try {
                    // Enviar mensaje de prueba al servidor
                    const response = await fetch('http://127.0.0.1:7100/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: 'Hola Sandra',
                            userId: 'ceo',
                            timestamp: Date.now()
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('‚úÖ Respuesta manual recibida:', result);
                        
                        if (result.reply || result.response) {
                            const reply = result.reply || result.response;
                            addMessage(reply, 'sandra');
                            speakWithElevenLabs(reply);
                        }
                        
                        updateMicStatus('‚úÖ Listo');
                        
                    } else {
                        console.error('‚ùå Error respuesta manual:', response.status);
                        updateMicStatus('‚ùå Error');
                        
                        // Fallback
                        const fallbackResponse = "¬°Hola! Soy Sandra, tu asistente de ClayTomSystems. Estoy aqu√≠ para ayudarte.";
                        addMessage(fallbackResponse, 'sandra');
                        speakWithElevenLabs(fallbackResponse);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error procesamiento manual:', error);
                    updateMicStatus('‚ùå Error');
                    
                    // Fallback final
                    const fallbackResponse = "Hola, soy Sandra de ClayTomSystems. ¬øEn qu√© puedo ayudarte?";
                    addMessage(fallbackResponse, 'sandra');
                    speakWithElevenLabs(fallbackResponse);
                }
            }
            
            function addMessage(text, sender) {
                const chatArea = document.getElementById('chat-area');
                const isUser = sender === 'user';
                
                const msgDiv = document.createElement('div');
                msgDiv.style.cssText = `
                    background: ${isUser ? '#dcf8c6' : '#e3f2fd'};
                    color: #333; 
                    padding: 8px; border-radius: 8px; 
                    margin-bottom: 8px; font-size: 13px;
                    ${isUser ? 'margin-left: 30px;' : 'margin-right: 30px;'}
                `;
                msgDiv.textContent = text;
                
                chatArea.appendChild(msgDiv);
                chatArea.scrollTop = chatArea.scrollHeight;
            }
            
            function updateMicStatus(status) {
                document.getElementById('mic-status').textContent = status;
            }
            
            // ElevenLabs TTS Integration
            async function speakWithElevenLabs(text) {
                try {
                    console.log('üé≠ Sandra va a hablar con ElevenLabs:', text.substring(0, 50) + '...');
                    updateMicStatus('üé≠ Generando voz...');
                    
                    // Configuraci√≥n ElevenLabs
                    const elevenLabsKey = 'API_DESACTIVADA_POR_SEGURIDAD';
                    const voiceId = 'VOICE_ID_DESACTIVADO'; // Voz Sandra
                    
                    const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
                        method: 'POST',
                        headers: {
                            'Accept': 'audio/mpeg',
                            'Content-Type': 'application/json',
                            'xi-api-key': elevenLabsKey
                        },
                        body: JSON.stringify({
                            text: text,
                            model_id: 'eleven_multilingual_v2',
                            voice_settings: {
                                stability: 0.5,
                                similarity_boost: 0.5
                            }
                        })
                    });
                    
                    if (response.ok) {
                        const audioBlob = await response.blob();
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = new Audio(audioUrl);
                        
                        audio.onplay = () => {
                            console.log('üé§ Sandra hablando con ElevenLabs');
                            updateMicStatus('üó£Ô∏è Sandra hablando...');
                        };
                        
                        audio.onended = () => {
                            console.log('‚úÖ Sandra termin√≥ de hablar');
                            updateMicStatus('üéß Escuchando...');
                            URL.revokeObjectURL(audioUrl);
                        };
                        
                        audio.onerror = (error) => {
                            console.error('‚ùå Error reproduciendo audio:', error);
                            updateMicStatus('‚ùå Error voz');
                        };
                        
                        // Reproducir voz
                        audio.play();
                        
                    } else {
                        console.error('‚ùå Error ElevenLabs:', response.status);
                        updateMicStatus('‚ùå Error ElevenLabs');
                        
                        // Fallback a Web Speech API
                        speakWithWebAPI(text);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error con ElevenLabs:', error);
                    updateMicStatus('‚ùå Error');
                    
                    // Fallback a Web Speech API
                    speakWithWebAPI(text);
                }
            }
            
            // Fallback TTS con Web Speech API
            function speakWithWebAPI(text) {
                try {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'es-ES';
                    utterance.rate = 0.9;
                    utterance.pitch = 1.1;
                    
                    utterance.onstart = () => {
                        updateMicStatus('üó£Ô∏è Sandra hablando...');
                    };
                    
                    utterance.onend = () => {
                        updateMicStatus('üéß Escuchando...');
                    };
                    
                    speechSynthesis.speak(utterance);
                    
                } catch (error) {
                    console.error('‚ùå Error Web Speech API:', error);
                    updateMicStatus('‚ùå Error voz');
                }
            }
            
            async function testConnection() {
                console.log('üîó Probando conexi√≥n con Sandra IA 7.0...');
                
                try {
                    const response = await fetch('http://127.0.0.1:7100/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: 'test',
                            userId: 'ceo'
                        })
                    });
                    
                    const status = document.getElementById('connection-status');
                    if (response.ok) {
                        status.textContent = 'üü¢ Sandra IA En l√≠nea';
                        console.log('‚úÖ Conexi√≥n con Sandra confirmada');
                    } else {
                        status.textContent = 'üü° Servidor local offline';
                        console.log('‚ö†Ô∏è Servidor no responde');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error conexi√≥n:', error);
                    const status = document.getElementById('connection-status');
                    status.textContent = 'üî¥ Modo offline';
                }
            }
            
            // Inicializar cuando el DOM est√© listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', createWidget);
            } else {
                createWidget();
            }
            
            console.log('‚úÖ Sandra Widget Conversacional Completo cargado');
            
        })();
    </script>
</body>
</html>